name: Jira to GitHub Integration (Zero-Cost)
permissions:
  issues: write
  contents: write
on:
  repository_dispatch:
    types: 
      - jira-bug-created
      - jira-label-added
      - jira-label-changed
  
  workflow_dispatch:
    inputs:
      bug_key:
        description: 'Jira Bug Key (e.g., BUG-123)'
        required: true
        type: string

concurrency:
  group: jira-bug-${{ github.event.client_payload.bug_key || github.event.inputs.bug_key }}
  cancel-in-progress: false

jobs:
  process-jira-bug:
    name: Process Jira Bug
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“‹ Display Bug Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         JIRA BUG RECEIVED (ZERO-COST METHOD)          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Trigger:     Jira Automation (${{ github.event.action }})"
            echo "Bug Key:     ${{ github.event.client_payload.bug_key }}"
            echo "Summary:     ${{ github.event.client_payload.summary }}"
            echo "Priority:    ${{ github.event.client_payload.priority }}"
            echo "Labels:      ${{ github.event.client_payload.labels }}"
          else
            echo "Trigger:     Manual Test"
            echo "Bug Key:     ${{ github.event.inputs.bug_key }}"
          fi
          echo ""
      
      - name: ðŸ Process Jira Bug
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JIRA_BUG_KEY: ${{ github.event.client_payload.bug_key || github.event.inputs.bug_key }}
        run: |
          python .github/scripts/process_jira_bug.py
      
      - name: ðŸ“¦ Upload Attachments as Backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jira-attachments-${{ github.event.client_payload.bug_key || github.event.inputs.bug_key }}
          path: attachments/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ðŸ“Š Create Job Summary
        if: always()
        run: |
          echo "# ðŸ Jira to GitHub Integration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bug Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Bug Key:** \`${{ github.event.client_payload.bug_key || github.event.inputs.bug_key }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’° Cost Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Monthly Cost:** \$0.00 âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "âœ¨ *Running on free GitHub Actions tier*" >> $GITHUB_STEP_SUMMARY


